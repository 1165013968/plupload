(function(b){var c={};function a(f,i,d,j){var i,d,e,g,h;g=google.gears.factory.create("beta.canvas");g.decode(f);scale=Math.min(i/g.width,d/g.height);if(scale<1){i=Math.round(g.width*scale);d=Math.round(g.height*scale)}else{i=g.width;d=g.height}g.resize(i,d);return g.encode("image/jpeg",{quality:j/100})}b.GearsRuntime=b.addRuntime("gears",{init:function(d,e){if(!window.google||!google.gears){e({success:false});return}d.bind("UploadFile",function(f,j){var i=0,l,k,h=0;k=f.settings.chunk_size;l=Math.ceil(j.size/k);c[j.id]=a(c[j.id],f.settings.image_width,f.settings.image_height,f.settings.image_quality);j.size=c[j.id].length;g();function g(){var m=f.settings.url,n,o;if(j.status==b.DONE||j.status==b.FAILED||f.state==b.STOPPED){return}o=Math.min(k,j.size-(i*k));n=google.gears.factory.create("beta.httprequest");n.open("POST",m+(m.indexOf("?")==-1?"?":"&")+"name="+escape(j.target_name||j.name)+"&chunk="+i+"&chunks="+l);n.setRequestHeader("Content-Disposition",'attachment; filename="'+j.name+'"');n.setRequestHeader("Content-Type","application/octet-stream");n.upload.onprogress=function(p){j.loaded=h+p.loaded;f.trigger("UploadProgress",j)};n.onreadystatechange=function(){var p;if(n.readyState==4){if(n.status==200){p={file:j,chunk:i,chunks:l,response:n.responseText};f.trigger("ChunkUploaded",p);if(p.cancelled){j.status=b.FAILED;f.trigger("FileUploaded",j);return}h+=o;if(++i>=l){j.status=b.DONE;f.trigger("FileUploaded",j)}else{g()}}else{f.trigger("UploadChunkError",{file:j,chunk:i,chunks:l,error:"Status: "+n.status})}}};if(i<l){n.send(c[j.id].slice(i*k,o))}}});d.bind("SelectFiles",function(f){var h=google.gears.factory.create("beta.desktop"),k=[],j,g;for(j=0;j<f.settings.filters.length;j++){ext=f.settings.filters[j].extensions.split(",");for(g=0;g<ext.length;g++){k.push("."+ext[g])}}h.openFiles(function(n){var m,l,o=[],p;for(l=0;l<n.length;l++){m=n[l];p=b.guid();c[p]=m.blob;o.push(new b.File(p,m.name,m.blob.length))}d.trigger("FilesSelected",o)},{singleFile:!f.settings.multi_selection,filter:k})});e({success:true})}})})(plupload);