(function(b){var d={},c=true;function a(g,j,e,l,k){var f,h,i;h=google.gears.factory.create("beta.canvas");h.decode(g);scale=Math.min(j/h.width,e/h.height);if(scale<1){j=Math.round(h.width*scale);e=Math.round(h.height*scale)}else{j=h.width;e=h.height}h.resize(j,e);return h.encode(k,{quality:l/100})}b.runtimes.Gears=b.addRuntime("gears",{init:function(g,i){var h;if(!window.google||!google.gears){return i({success:false})}try{h=google.gears.factory.create("beta.desktop")}catch(e){return i({success:false})}function f(l){var k,j,m=[],n;for(j=0;j<l.length;j++){k=l[j];n=b.guid();d[n]=k.blob;m.push(new b.File(n,k.name,k.blob.length))}g.trigger("FilesAdded",m)}g.bind("PostInit",function(){var k=g.settings,j=document.getElementById(k.drop_element);if(j){b.addEvent(j,"dragover",function(l){l.preventDefault()});b.addEvent(j,"drop",function(m){var l=h.getDragData(m,"application/x-gears-files");if(l){f(l.files)}m.preventDefault()});j=0}b.addEvent(document.getElementById(k.browse_button),"click",function(p){var o=[],m,l,n;p.preventDefault();for(m=0;m<k.filters.length;m++){n=k.filters[m].extensions.split(",");for(l=0;l<n.length;l++){o.push("."+n[l])}}h.openFiles(f,{singleFile:!k.multi_selection,filter:o})})});g.bind("UploadFile",function(n,k){var r=0,o,l,m=0,q,p;q=n.settings.image_width;p=n.settings.image_height;l=n.settings.chunk_size;o=Math.ceil(k.size/l);if(/\.(png|jpg|jpeg)$/i.test(k.name)&&(q||p)){d[k.id]=a(d[k.id],q,p,n.settings.image_quality,/\.png$/i.test(k.name)?"image/png":"image/jpeg")}k.size=d[k.id].length;j();function j(){var s=n.settings.url,t,u;if(k.status==b.DONE||k.status==b.FAILED||n.state==b.STOPPED){return}u=Math.min(l,k.size-(r*l));t=google.gears.factory.create("beta.httprequest");t.open("POST",s+(s.indexOf("?")==-1?"?":"&")+"name="+escape(k.target_name||k.name)+"&chunk="+r+"&chunks="+o);t.setRequestHeader("Content-Disposition",'attachment; filename="'+k.name+'"');t.setRequestHeader("Content-Type","application/octet-stream");t.upload.onprogress=function(v){k.loaded=m+v.loaded;n.trigger("UploadProgress",k)};t.onreadystatechange=function(){var v;if(t.readyState==4){if(t.status==200){v={file:k,chunk:r,chunks:o,response:t.responseText};n.trigger("ChunkUploaded",v);if(v.cancelled){k.status=b.FAILED;n.trigger("FileUploaded",k);return}m+=u;if(++r>=o){k.status=b.DONE;n.trigger("FileUploaded",k)}else{j()}}else{n.trigger("UploadChunkError",{file:k,chunk:r,chunks:o,error:"Status: "+t.status})}}};if(r<o){t.send(d[k.id].slice(r*l,u))}}});g.features={dragdrop:c,jpgresize:c,pngresize:c,chunks:c};i({success:c})}})})(plupload);