(function(b){function a(h,k,i,c,j){var e,d,g,f;e=document.createElement("canvas");e.style.display="none";document.body.appendChild(e);d=e.getContext("2d");g=new Image();g.onload=function(){var n,l,m;scale=Math.min(k/g.width,i/g.height);if(scale<1){n=Math.round(g.width*scale);l=Math.round(g.height*scale)}else{n=g.width;l=g.height}e.width=n;e.height=l;d.drawImage(g,0,0,n,l);f=e.toDataURL(c);f=f.substring(f.indexOf("base64,")+7);f=atob(f);e.parentNode.removeChild(e);j({success:true,data:f})};g.src=h}b.Html5Runtime=b.addRuntime("html5",{init:function(g,h){var d,f,c={};function e(){var i;if(window.XMLHttpRequest){i=new XMLHttpRequest();return !!(i.sendAsBinary||i.upload)}return false}if(!e()){h({success:false});return}g.bind("Init",function(k){var q,j=[],l,p,o=k.settings.filters,n,m;q=document.createElement("div");q.id=k.id+"_html5_container";for(l=0;l<o.length;l++){n=o[l].extensions.split(/,/);for(p=0;p<n.length;p++){m=b.mimeTypes[n[p]];if(m){j.push(m)}}}b.extend(q.style,{position:"absolute",background:g.settings.html5_bgcolor||"transparent",width:"100px",height:"100px",overflow:"hidden",opacity:0});q.className="plupload_html5";document.body.appendChild(q);q.innerHTML='<input id="'+g.id+'_html5" style="width:100%;" type="file" accept="'+j.join(",")+'" '+(g.settings.multi_selection?'multiple="multiple"':"")+" />";document.getElementById(g.id+"_html5").onchange=function(){var s,r,t=[],u;for(r=0;r<this.files.length;r++){s=this.files[r];u=b.guid();c[u]=s;t.push(new b.File(u,s.fileName,s.fileSize))}g.trigger("FilesSelected",t);this.value=""}});g.bind("Refresh",function(i){var j,k;j=document.getElementById(g.settings.browse_button);k=b.getPos(j);b.extend(document.getElementById(g.id+"_html5_container").style,{top:k.y+"px",left:k.x+"px",width:j.offsetWidth+"px",height:j.offsetHeight+"px"})});g.bind("UploadFile",function(j,n){var p=new XMLHttpRequest(),m,l=j.settings.url,k,i,o;if(n.status==b.DONE||n.status==b.FAILED||j.state==b.STOPPED){return}if(m=p.upload){m.onload=function(){n.status=b.DONE;j.trigger("FileUploaded",n)};m.onprogress=function(q){n.loaded=q.loaded;j.trigger("UploadProgress",n)}}p.onreadystatechange=function(){if(p.readyState==4){n.status=b.DONE;n.loaded=n.size;j.trigger("UploadProgress",n);j.trigger("FileUploaded",n)}};p.open("post",l+(l.indexOf("?")==-1?"?":"&")+"name="+escape(n.target_name||n.name),true);p.setRequestHeader("Content-Type","application/octet-stream");o=c[n.id];if(p.sendAsBinary){k=j.settings.image_width;i=j.settings.image_height;if(/\.(png|jpg|jpeg)$/i.test(n.name)&&(k||i)){a(o.getAsDataURL(),k,i,/\.png$/i.test(n.name)?"image/png":"image/jpeg",function(q){if(q.success){n.size=q.data.length;p.sendAsBinary(q.data)}else{p.sendAsBinary(o.getAsBinary())}})}else{p.sendAsBinary(o.getAsBinary())}}else{p.send(o)}});h({success:true})}})})(plupload);