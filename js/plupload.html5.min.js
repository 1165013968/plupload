(function(b){function a(h,g,f,i){var d,e,c;d=document.createElement("canvas");d.style.display="none";document.body.appendChild(d);e=d.getContext("2d");c=new Image();c.onload=function(){var l,j,k;scale=Math.min(g/c.width,f/c.height);if(scale<1){l=Math.round(c.width*scale);j=Math.round(c.height*scale)}else{l=c.width;j=c.height}d.width=l;d.height=j;e.drawImage(c,0,0,l,j);i({success:true,data:atob(d.toDataURL("image/jpeg").substring(23))});d.parentNode.removeChild(d)};c.src=h}b.Html5Runtime=b.addRuntime("html5",{init:function(g,h){var d,f,c={};function e(){var i;if(window.XMLHttpRequest){i=new XMLHttpRequest();return !!(i.sendAsBinary||i.upload)}return false}if(!e()){h({success:false});return}g.bind("Init",function(k){var q,j=[],l,p,o=k.settings.filters,n,m;q=document.createElement("div");q.id=k.id+"_html5_container";for(l=0;l<o.length;l++){n=o[l].extensions.split(/,/);for(p=0;p<n.length;p++){m=b.mimeTypes[n[p]];if(m){j.push(m)}}}b.extend(q.style,{position:"absolute",background:g.settings.html5_bgcolor||"transparent",width:"100px",height:"100px",overflow:"hidden",opacity:0});q.className="plupload_html5";document.body.appendChild(q);q.innerHTML='<input id="'+g.id+'_html5" style="width:100%;" type="file" accept="'+j.join(",")+'" '+(g.settings.multi_selection?'multiple="multiple"':"")+" />";document.getElementById(g.id+"_html5").onchange=function(){var s,r,t=[],u;for(r=0;r<this.files.length;r++){s=this.files[r];u=b.guid();c[u]=s;t.push(new b.File(u,s.fileName,s.fileSize))}g.trigger("FilesSelected",t);this.value=""}});g.bind("Refresh",function(i){var j,k;j=document.getElementById(g.settings.browse_button);k=b.getPos(j);b.extend(document.getElementById(g.id+"_html5_container").style,{top:k.y+"px",left:k.x+"px",width:j.offsetWidth+"px",height:j.offsetHeight+"px"})});g.bind("UploadFile",function(j,m){var p=new XMLHttpRequest(),l,k=j.settings.url,n,i,o;if(m.status==b.DONE||m.status==b.FAILED||j.state==b.STOPPED){return}if(l=p.upload){l.onload=function(){m.status=b.DONE;j.trigger("FileUploaded",m)};l.onprogress=function(q){m.loaded=q.loaded;j.trigger("UploadProgress",m)}}p.onreadystatechange=function(){if(p.readyState==4){m.status=b.DONE;m.loaded=m.size;j.trigger("UploadProgress",m);j.trigger("FileUploaded",m)}};p.open("post",k+(k.indexOf("?")==-1?"?":"&")+"name="+escape(m.target_name||m.name),true);p.setRequestHeader("Content-Type","application/octet-stream");o=c[m.id];if(p.sendAsBinary){n=j.settings.image_width;i=j.settings.image_height;if(n||i){a(o.getAsDataURL(),n,n,function(q){if(q.success){p.sendAsBinary(q.data)}else{p.sendAsBinary(o.getAsBinary())}})}else{p.sendAsBinary(o.getAsBinary())}}else{p.send(o)}});h({success:true})}})})(plupload);